# Session 4: Frontend UI, Database Seeding, Chat, Dashboard & CEFR Migration (2026-02-19)

## Overview

Built out the entire frontend UI across 7 commits. The app went from backend-only (IPC handlers, core logic, no UI) to a fully functional desktop app with 5 navigable pages, a working SRS review engine, a streaming AI chatbot, a knowledge base browser, a data-driven dashboard with frontier visualizations, and a daily narrative brief. Also seeded the database with realistic test data and migrated the entire codebase from JLPT to CEFR levels.

---

## What Was Built

### 1. UI Framework & App Shell (`cc587ce`)

**`src/components/app-shell.tsx`** — Sidebar navigation with 5 tabs:
- Dashboard, Review, Learn, Knowledge Base, Chat
- Uses `NavLink` from react-router with active state highlighting
- macOS titlebar drag region support (52px offset)
- Lucide icons for each nav item

**`src/app.tsx`** — Route setup with `HashRouter`:
- `/dashboard`, `/review`, `/learn`, `/knowledge`, `/chat`
- Auto-redirect from `/` to `/dashboard`

**`src/styles/global.css`** — Custom styles for the dark theme, scrollbar styling, Radix UI overrides

**`src/env.d.ts`** — TypeScript declarations for `window.linguist` IPC API surface (all 30+ methods) and `window.platform`

**`src/constants/mastery.ts`** — Shared mastery state constants:
- `MASTERY_ORDER`: canonical ordering from unseen through burned
- `MASTERY_COLORS`: color mapping for badges (gray -> red -> orange -> yellow -> green -> blue -> purple)
- `MASTERY_LABELS`: human-readable labels for each state

**`electron/preload.ts`** — Expanded context bridge exposing all IPC channels to the renderer, including event listeners for streaming chat (`chatOnChunk`, `chatOnDone`)

### 2. Database Seeding (`75a780f`)

**`prisma/seed.ts`** — Full seed script with realistic Japanese learning data:

- **LearnerProfile**: A1 Japanese learner, English native, 10 items/day, 90% retention target
- **PragmaticProfile**: Default polite register
- **30 vocabulary items** across 6 mastery states:
  - 8 apprentice_1 (due today, 1-day stability)
  - 6 apprentice_2 (due today, 2-day stability)
  - 4 apprentice_3 (4-day stability, some production evidence)
  - 4 journeyman (14-day stability, 4-8 production events)
  - 4 introduced (not yet in SRS)
  - 4 unseen
- **8 grammar patterns** (te-form, tai-form, nai-form, desu, particle-wa, particle-ga, past tense, particle-ni) across apprentice_1, apprentice_2, introduced, unseen
- FSRS states are realistic: proper stability, difficulty, reps, elapsed_days, and last_review dates
- Tags include level and part-of-speech metadata
- 27 items due for review on first launch

### 3. Knowledge Base Page (`d2d7216`)

**`src/pages/knowledge/index.tsx`** — Searchable, filterable table of all vocabulary items:
- Search by word, reading, or meaning (calls `wordbank:search` IPC)
- Mastery state dropdown filter with all 10 states
- Item count display
- Table columns: Word, Reading, Meaning, Type, Mastery (color-coded badge), Recognition due date (relative: "2d overdue", "Due now", "Tomorrow"), Stability (days)
- Uses `useWordbank` hook for data fetching

**`src/hooks/use-wordbank.ts`** — Custom hook wrapping `wordbank:list` and `wordbank:search` IPC calls with loading state, search, filter, and reload

### 4. Dashboard & Frontier Visualizations (`c3b2e35`)

**`src/pages/dashboard/index.tsx`** — Main dashboard with:
- Due count card with "Start Review" link
- Today's reviewed count and accuracy percentage
- Learn card with "New Session" link
- Daily narrative brief (AI-generated summary)
- Frontier visualization container

**`src/pages/dashboard/daily-brief.tsx`** — AI-powered daily summary:
- Builds draft from frontier data + ToM brief using template engine
- Shows template text immediately, then async-polishes via Claude API
- Caches polished version in localStorage per day
- Graceful fallback if API unavailable

**`core/narrative/draft.ts`** — Template engine for daily brief:
- Extracts level, coverage, modality strengths/weaknesses, active item count, streak
- Pulls gap/avoidance/confusion/regression counts from ToM brief
- Generates 3-5 sentence natural language summary

**`electron/ipc/narrative.ts`** — Two IPC handlers:
- `narrative:build-draft`: runs template engine, returns `NarrativeDraft`
- `narrative:polish`: sends draft to Claude API for natural language refinement

**`src/pages/dashboard/frontier/frontier-container.tsx`** — View container with toggle between 3 visualization modes

**`src/pages/dashboard/frontier/view-toggle.tsx`** — Segmented control: Bars / Radar / Dot Map

**`src/pages/dashboard/frontier/level-bars-view.tsx`** — Primary view:
- Level progress bars (coverage per CEFR level)
- Mastery pipeline distribution
- Comprehension vs production ceiling comparison

**`src/pages/dashboard/frontier/radar-levels-view.tsx`** — Combined view:
- SVG radar chart showing reading/writing/listening/speaking balance
- Level progress bars alongside

**`src/pages/dashboard/frontier/dot-map-view.tsx`** — Grid visualization:
- CEFR levels as columns, mastery states as rows
- Each item rendered as a colored dot (blue = lexical, purple = grammar)
- Tooltips showing item surface form on hover
- Overflow count for cells with 50+ items

**Frontier sub-components:**
- `level-progress-bar.tsx` — Dual-layer progress bar (dark = production-ready, light = recognition-known), current/frontier/above-frontier indicators
- `mastery-pipeline.tsx` — Horizontal pipeline showing item flow through mastery stages
- `ceiling-comparison.tsx` — Side-by-side vertical bars for comprehension vs production ceiling (6 CEFR levels)
- `radar-chart.tsx` — Pure SVG radar chart with 4 axes, animated fill
- `dot-map-grid.tsx` — Grid layout with tooltips per item
- `dot-map-legend.tsx` — Color legend for dot types

**`src/hooks/use-frontier.ts`** — Hook wrapping `dashboard:get-frontier` IPC call

**`electron/ipc/dashboard.ts`** — `DASHBOARD_GET_FRONTIER` handler: gathers all items, computes knowledge bubble, builds frontier item list with mastery distribution

**`electron/ipc/_helpers/gather-items.ts`** — Shared helper for querying all lexical + grammar items and mapping to `BubbleItemInput[]`, plus `toExpandedProfile()` helper

### 5. SRS Review Engine UI (`c3b2e35`)

**`src/pages/review/index.tsx`** — Review session page:
- Loading state, empty queue state, active review, and completion summary
- Progress bar showing position in queue
- Keyboard-driven flow

**`src/pages/review/review-card.tsx`** — Flashcard component:
- **Recognition mode**: Shows Japanese word + reading, user recalls meaning, presses Space to reveal
- **Production mode**: Shows meaning, user types Japanese word in text field, presses Enter to check
- Answer reveal with color feedback (green = correct, red = incorrect for production)
- 4-button grading: Again (1), Hard (2), Good (3), Easy (4) with keyboard shortcuts
- Mastery badge shown on back of card
- Auto-focus and state reset between cards

**`src/pages/review/session-summary.tsx`** — Post-session summary:
- Cards reviewed, accuracy percentage, mastery state changes
- "Back to Dashboard" and "Review Again" buttons

**`src/hooks/use-review.ts`** — Review session state management:
- Loads queue via `review:get-queue` IPC
- Tracks current index, session stats (reviewed, correct, wrong, mastery changes)
- Submits grades via `review:submit` IPC and advances to next card

### 6. AI Insight Narrative (`a579e81`)

**`core/narrative/prompt.ts`** — Builds Claude prompt for polishing the daily brief template into natural, encouraging prose

**`electron/ipc/narrative.ts`** — Calls Claude API to transform template text into polished narrative

### 7. Streaming Chat Bot (`11c7bae`)

**`electron/ipc/chat.ts`** — Streaming chat handler using Vercel AI SDK:
- Uses `streamText()` with `@ai-sdk/anthropic` provider (Claude Sonnet)
- Streams token-by-token via `event.sender.send('chat:chunk', ...)` IPC events
- Abort support: `chat:stop` cancels active stream via `AbortController`
- Tracks active streams per conversation ID, cleans up on completion

**`src/pages/chat/index.tsx`** — Multi-conversation chat page:
- Create/switch/delete conversations via dropdown
- Auto-titles conversations from first message
- Manages message state per conversation
- Empty conversation deduplication

**`src/pages/chat/chat-view.tsx`** — Chat interface:
- Auto-growing textarea input with Shift+Enter for newlines
- Real-time streaming display (token-by-token rendering)
- Stop button during generation
- Auto-scroll to bottom on new messages
- IPC event listeners for `chat:chunk` and `chat:done`

**`src/pages/chat/message-bubble.tsx`** — Message rendering:
- User messages right-aligned with accent background
- Assistant messages left-aligned
- Streaming indicator (blinking cursor)

**Dependencies added:** `ai`, `@ai-sdk/anthropic` (Vercel AI SDK for streaming)

### 8. CEFR Migration (`871a320`)

Replaced JLPT levels (N5/N4/N3/N2/N1) with CEFR levels (A1/A2/B1/B2/C1/C2) across the entire codebase to make the level system language-agnostic.

**Mapping:** N5->A1, N4->A2, N3->B1, N2->B2, N1->C1. C2 added as new top tier.

**Scope:** ~20 files modified:

- **Prisma schema**: `jlptLevel` -> `cefrLevel` on LexicalItem, GrammarItem, CurriculumItem; LearnerProfile defaults changed to `"A1"`
- **Migration SQL**: Column renames + `CASE` statements mapping all existing data + `ALTER COLUMN SET DEFAULT` for LearnerProfile
- **Shared types**: `CurriculumRecommendation`, `ExpandedItemDetail`, `FrontierItem` field renames
- **Core logic** (4 files): `JLPT_LEVELS` -> `CEFR_LEVELS` (6 levels), `JlptLevel` -> `CefrLevel` type, `jlptIndex()` -> `cefrIndex()`, `isValidJlpt()` -> `isValidCefr()`, all fallback defaults `'N5'` -> `'A1'`
- **Reference data JSON** (250 entries): All `"jlptLevel"` keys renamed to `"cefrLevel"`, values mapped
- **Seed data**: All level references updated
- **IPC handlers** (7 files): Field mapping updates
- **UI components** (4 files): Level arrays, ceiling comparison (now 6 levels), dot map grid columns

Grammar `patternId` prefixes (e.g., `n5_desu`) intentionally preserved — they're internal identifiers, not level labels.

### 9. UI Cleanup

- Removed Insights tab from sidebar navigation and route config (content was a stub; ToM data is surfaced through the dashboard daily brief instead)

---

## Files Created (24)

| File | Purpose |
|---|---|
| `src/components/app-shell.tsx` | Sidebar navigation shell |
| `src/constants/mastery.ts` | Mastery state colors, labels, ordering |
| `src/env.d.ts` | TypeScript declarations for IPC API |
| `src/styles/global.css` | Global styles and Radix overrides |
| `src/hooks/use-frontier.ts` | Dashboard frontier data hook |
| `src/hooks/use-wordbank.ts` | Knowledge base data hook |
| `src/pages/knowledge/index.tsx` | Knowledge base page |
| `src/pages/chat/index.tsx` | Multi-conversation chat page |
| `src/pages/chat/chat-view.tsx` | Streaming chat interface |
| `src/pages/chat/message-bubble.tsx` | Message bubble component |
| `src/pages/dashboard/daily-brief.tsx` | AI narrative daily summary |
| `src/pages/dashboard/frontier/frontier-container.tsx` | Frontier visualization container |
| `src/pages/dashboard/frontier/view-toggle.tsx` | Bars/Radar/DotMap toggle |
| `src/pages/dashboard/frontier/level-bars-view.tsx` | Level bars + mastery pipeline view |
| `src/pages/dashboard/frontier/radar-levels-view.tsx` | Radar chart + level bars view |
| `src/pages/dashboard/frontier/dot-map-view.tsx` | Dot map visualization |
| `src/pages/dashboard/frontier/components/*.tsx` | 6 visualization sub-components |
| `src/pages/review/review-card.tsx` | SRS flashcard with keyboard shortcuts |
| `src/pages/review/session-summary.tsx` | Post-review session summary |
| `core/narrative/draft.ts` | Template engine for daily brief |
| `core/narrative/prompt.ts` | Claude prompt for brief polishing |
| `electron/ipc/dashboard.ts` | Dashboard frontier IPC handler |
| `electron/ipc/narrative.ts` | Narrative build/polish IPC handlers |
| `electron/ipc/chat.ts` | Streaming chat IPC handler |
| `electron/ipc/_helpers/gather-items.ts` | Shared item gathering helper |
| `prisma/seed.ts` | Database seed script (30 vocab, 8 grammar) |
| `prisma/migrations/20260220040000_rename_jlpt_to_cefr/` | CEFR migration |

## Files Modified (18)

| File | Changes |
|---|---|
| `src/app.tsx` | Added routes, removed Insights |
| `src/pages/dashboard/index.tsx` | Rewired with cards, brief, frontier |
| `src/pages/review/index.tsx` | Full review session flow |
| `src/hooks/use-review.ts` | Session state management |
| `electron/main.ts` | Registered dashboard, narrative, chat handlers |
| `electron/preload.ts` | Exposed all IPC methods + chat event listeners |
| `shared/types.ts` | Added ChatMessage, NarrativeDraft, chat IPC channels; jlptLevel -> cefrLevel |
| `prisma/schema.prisma` | jlptLevel -> cefrLevel, default N5 -> A1 |
| `core/profile/calculator.ts` | JLPT -> CEFR levels |
| `core/curriculum/bubble.ts` | JLPT -> CEFR levels |
| `core/curriculum/recommender.ts` | JLPT -> CEFR field names |
| `core/curriculum/reference-data.ts` | JLPT -> CEFR field names |
| `core/curriculum/data/japanese-reference.json` | 250 entries: jlptLevel -> cefrLevel, values mapped |
| `core/conversation/planner.ts` | Default N5 -> A1 |
| `electron/ipc/conversation.ts` | jlptLevel -> cefrLevel, N5 -> A1 |
| `electron/ipc/curriculum.ts` | jlptLevel -> cefrLevel |
| `electron/ipc/reviews.ts` | jlptLevel -> cefrLevel |
| `electron/ipc/tom.ts` | recommendedDifficulty N5 -> A1 |
| `package.json` | Added ai, @ai-sdk/anthropic dependencies |

---

## Verification

- `npx prisma generate` — Prisma client regenerated
- `npx prisma migrate reset --force` — All 3 migrations applied cleanly, seed runs
- `npm run typecheck` — PASS (zero errors)
- `npm run dev` — App launches, dashboard loads frontier data, review queue populated with 27 items, chat streams responses
- Grep for remaining `jlpt` references — zero matches (only grammar patternId prefixes like `n5_desu` use the `n5` prefix, which is intentional)

---

## Current Project State

### What's Working
- **Dashboard**: Due count, today's stats, daily AI brief, 3 frontier visualizations (level bars, radar chart, dot map)
- **Review**: Full SRS session — recognition/production cards, keyboard shortcuts, 4-grade input, FSRS scheduling, session summary
- **Knowledge Base**: Searchable/filterable table of all vocabulary with mastery badges, due dates, stability
- **Chat**: Multi-conversation streaming chatbot with Claude Sonnet, abort support, conversation management
- **Learn**: Conversation partner page (session planning + chat interface)
- **Database**: Seeded with 30 vocab + 8 grammar items, 27 due for review, CEFR levels throughout
- **Backend**: All 30+ IPC handlers wired, FSRS scheduling, mastery state machine, profile recalculation, ToM analysis, curriculum recommendations

### What's Not Yet Built
- Onboarding/placement flow
- Word bank item detail view (editing, tag management)
- Curriculum UI (viewing/accepting/skipping recommendations)
- Profile/settings page
- Learn page conversation session flow (currently just routes to the page)
